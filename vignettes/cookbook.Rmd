---
title: "Data visualization cookbook for the Center for Rural Innovation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data visualization cookbook for the Center for Rural Innovation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  # Chart settings
  fig.retina = 2,
  fig.width = 6,
  fig.asp = .75,
  fig.show = "hold",
  out.width = "100%"
)

# Set figure display options
options(dplyr.print_min = 6, dplyr.print_max = 6)

```

## Install Montserrat

```{r, message=FALSE, warning = FALSE}
library(sysfonts)
library(showtext)

# Loads Montserrat from the google font repository and adds it to sysfonts
sysfonts::font_add_google("Montserrat")
# Ensures that any newly opened graphics devices will use showtext to draw text
showtext_auto()
```

## Load required libraries

```{r, message = FALSE, warning = FALSE}
library(cori.charts)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
```

## Load your data

We will be using a dataset which gives the population with an income below the 
poverty level in the last 12 months for a subset of RIN communities.
```{r}
data(cori_poverty)
dplyr::glimpse(cori_poverty)
```
Now we are ready to begin charting!

# Chart Recipes

----  

## Horizontal Bar Chart

```{r}
cori_poverty %>%
  ggplot2::ggplot(
    aes(
      estimate_below_poverty_level_2019,
      # Make RIN communities appear in descending order
      # based upon their population below the poverty level
      reorder(rin_community, estimate_below_poverty_level_2019)
    )
  ) +
  # Set the bar color the the CORI "Emerald" color
  ggplot2::geom_col(fill = cori_colors["Emerald"]) +
  # Add data labels to the bars
  geom_text(
    aes(
      # You can adjust the scales function depending on the desired
      # number format (e.g., percent, dollar, etc.)
      label = scales::number(
        estimate_below_poverty_level_2019,
        # accuracy determines what number to round to (e.g., accuracy = 0.01 will show 2 decimal places)
        accuracy = 1,
        # big.mark determines the character used between every 3 digits to separate thousands
        big.mark = ","
      )
    ),
    # Provide spacing between the data label and the bar position
    hjust = -.1,
    # Data labels need to have their font family explicitly set to "Montserrat"
    family = "Montserrat"
  ) +
  ggplot2::scale_x_continuous(
    # labels determines whether tick labels are shown
    labels = NULL,
    # You can provide an expansion multiplier to the axis to ensure that
    # data labels will have enough space
    expand = expansion(mult = c(.005, .1))
  ) +
  # Call the horizontal bar theme to pull in default CORI theming
  theme_cori_horizontal_bars() +
  # Override any defaults styles using the ggplot2::theme() function AFTER
  # calling theme_cori_horizontal_bars()
  ggplot2::theme(
    panel.grid.major.x = element_blank()
  ) +
  # Provide Title, subtitle, etc.
  ggplot2::labs(
    title = "Population living below the poverty level",
    subtitle = "For select RIN communities (2019)",
    y = NULL,
    x = NULL,
    caption = "Source: ACS 5-year estimates (2019)"
  )
```

----  

## Grouped Bar Chart

Pivot the data into a long format for easy plotting
```{r}
grouped_bar_data <- cori_poverty %>%
  mutate(
    percent_below_poverty_2014 = estimate_below_poverty_level_2014 / estimate_pop_2014,
    percent_below_poverty_2019 = estimate_below_poverty_level_2019 / estimate_pop_2019
  ) %>%
  pivot_longer(
    contains("percent"),
    names_to = "year",
    values_to = "percent_below_poverty"
  ) %>%
  mutate(
    year = str_remove(year, "percent_below_poverty_"),
    rin_community = reorder(rin_community, percent_below_poverty)
  ) 

glimpse(grouped_bar_data)
```

With data labels
```{r}
grouped_bar_data %>%
  ggplot(aes(percent_below_poverty, rin_community, fill = year)) +
  geom_col(position = "dodge") +
  # Add in data labels
  geom_text(
    aes(label = scales::percent(percent_below_poverty, accuracy = 1)),
    # Need to add a position value to ensure that the data labels
    # are aligned with their appropriate bar
    position = position_dodge2(width = 0.9, reverse = FALSE),
    hjust = -.1,
    family = "Montserrat"
  ) +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    # Axis labels are redundant to the data labels,
    # so we don't display them by setting labels = NULL
    labels = NULL,
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: U.S. Census Bureau"
  ) +
  theme_cori_horizontal_bars()
```

Without data labels
```{r}
grouped_bar_data %>%
  ggplot(aes(percent_below_poverty, rin_community, fill = year)) +
  geom_col(position = "dodge") +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    # Add back axis labels to provide context
    # because we aren't displaying data labels
    labels = scales::label_percent(accuracy = 1),
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: U.S. Census Bureau"
  ) +
  theme_cori_horizontal_bars()
```

----  

## Bullet Chart

```{r, warning = FALSE, message = FALSE}
# Create a column for the width of the two bars using dplyr:: mutate()
#
# Generally, when comparing time periods, the wide bar is the
# earlier time period and the skinny bar is the later time period
bullet_chart_data <- grouped_bar_data %>%
  dplyr::mutate(
    width = ifelse(year == "2014", 0.75, 0.5)
  )

glimpse(bullet_chart_data)
```

```{r, warning = FALSE, message=FALSE}
bullet_chart_data %>%
  ggplot(aes(x = percent_below_poverty, y = rin_community, fill = year)) +
  # Determine the width using the "width" column we created above
  geom_col(width = bullet_chart_data$width) +
  # Add data labels for the later time period only
  geom_text(
    data = dplyr::filter(bullet_chart_data, year == "2019"),
    aes(x = percent_below_poverty, label = scales::percent(percent_below_poverty, accuracy = 1)),
    hjust = 1.3,
    family = "Montserrat",
    color = "white"
  ) +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    labels = scales::label_percent(accuracy = 1),
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: ACS 5-year estimates"
  ) +
  theme_cori_horizontal_bars()
```

----  

## Line Charts

```{r}
data("cori_education")

# Clean up the labels for the chart
line_chart_data <- cori_education %>%
  dplyr::mutate(
    # Remove underscores and convert to title case
    education_clean = stringr::str_to_title(stringr::str_replace_all(education, "_", " "))
  )

# Prep work so that the legend labels can be ordered based upon their final data point
#
# Filter to the final data point and pull the order
latest_date <- line_chart_data %>% pull(date) %>% max()
factor_order <- line_chart_data %>%
  dplyr::filter(date == latest_date) %>%
  dplyr::arrange(desc(percent_working_remotely)) %>%
  pull(education_clean)

# Update the column based upon the preferred order
line_chart_data <- line_chart_data %>%
  dplyr::mutate(education_clean = factor(education_clean, levels = factor_order))

glimpse(line_chart_data)
```
Simple line chart with right-hand legend
```{r, fig.asp=2/3}
# When using line charts, you need to 
# update the geom defaults before plotting
update_cori_geom_defaults()

line_chart_data %>%
  ggplot(
       aes(date, percent_working_remotely, color = education_clean)) +
  geom_line() +
  scale_color_cori(guide = guide_legend(reverse = TRUE)) +
  scale_x_date(
    date_breaks = "3 months",
    date_labels =  "%b '%y",
    expand = expansion(mult = c(.01,.01))
  ) +
  scale_y_continuous(
    labels = scales::label_percent(accuracy = 1),
    limits = c(0, .65),
    expand = expansion(mult = c(0, .1))
  ) +
  theme_cori() +
  ggplot2::theme(
    # CORI themes defaults to a horizontal legend below the title,
    # but with long names it can be easier to display the legend on the right
    legend.position = "right",
    legend.direction = "vertical",
    # Add ticks to the x-axis
    axis.ticks.x = element_line(color = "#d0d2ce"),
    axis.ticks.length = unit(4, 'pt')
  ) +
  # In order for a legend on the right to render properly,
  # you need to specify that byrow = TRUE
  guides(color = guide_legend(byrow = TRUE)) +
  labs(title = "Percent of workers able to work from home",
       subtitle = "By education level (May 2020 - December 2021)",
       x = NULL,
       y = NULL,
       caption = "Source: Bureau of Labor Statistics")
```
If your lines are spaced further apart, you can use a secondary axis to directly label the line endpoints
```{r, fig.asp=2/3}
# Let's filter to just two lines to simplify the chart
direct_label_data <- line_chart_data %>%
  dplyr::filter(
    education == "bachelors_or_higher" | education == "some_college_or_associates"
  )

# Determine the value and label at the most recent date for each line
line_labels <- direct_label_data %>%
  dplyr::filter(date == latest_date) %>%
  dplyr::arrange(desc(percent_working_remotely)) %>%
  pull(education_clean)

line_values <- direct_label_data %>%
  dplyr::filter(date == latest_date) %>%
  dplyr::arrange(desc(percent_working_remotely)) %>%
  pull(percent_working_remotely)

direct_label_data %>%
  ggplot(
       aes(date, percent_working_remotely, color = education_clean)) +
  geom_line() +
  scale_color_cori(guide = guide_legend(reverse = TRUE)) +
  scale_x_date(
    date_breaks = "3 months",
    date_labels =  "%b '%y",
    expand = expansion(mult = c(.01,0))
  ) +
  scale_y_continuous(
    labels = scales::label_percent(accuracy = 1),
    limits = c(0, .65),
    expand = expansion(mult = c(0, .1)),
    # Add the direct labels as a second axis
    sec.axis = sec_axis(
      trans = ~.*1,
      breaks = line_values,
      labels = line_labels
    )
  ) +
  theme_cori() +
  ggplot2::theme(
    # Remove the legend
    legend.position = "none",
    # Add ticks to the x-axis
    axis.ticks.x = element_line(color = "#d0d2ce"),
    axis.ticks.length = unit(4, 'pt')
  ) +
  labs(
    title = "Percent of workers able to work from home",
    subtitle = "By education level (May 2020 - December 2021)",
    x = NULL,
    y = NULL,
    caption = "Source: Bureau of Labor Statistics"
  )
```

----  

## Maps  

Choropleth 

```{r, results='hide'}

# We'll use 2019 county-level data on computer and math jobs
acs19_vars <- c("comp_math_male" = "C24010_008", "comp_math_female" = "C24010_044")
dta <- tidycensus::get_acs(
    "county",
    year = 2019,
    variables = acs19_vars,
    geometry = TRUE
  ) %>%
  dplyr::group_by(GEOID) %>%
  dplyr::summarise(
    estimate = sum(estimate, na.rm = TRUE)
  ) %>%
  dplyr::rename(
    geoid = GEOID
  )

dta <- dta %>%
  dplyr::mutate(
    pct = estimate / sum(dta$estimate, na.rm = TRUE),
    grouping = ifelse (pct > .015, ">1.5% share", 
                       ifelse( pct > .005, ">=0.5% share", "<0.5% share")),
    geoid_st = stringr::str_sub(geoid, 1, 2)
  ) %>%
  dplyr::filter(geoid_st < "60") %>%
  tigris::shift_geometry(geoid_column = "geoid", position = "below")

# Load in states geometry
states <- tigris::states(cb = TRUE, year = 2010) %>%
  dplyr::filter(STATE < "60") %>%
  sf::st_as_sf() %>%
  tigris::shift_geometry(geoid_column = "STATE", position = "below")

fill_scale <- c(">1.5% share" = "#A3E2B5", ">=0.5% share" = "#456E66", "<0.5% share" = "#16343E")

# Specify points in WGS84
us_limits_wgs84 <- sf::st_sfc(sf::st_point(c(-120, 0)), sf::st_point(c(-65, 35)), crs = 4326)
# Convert to Albers
us_limits_albers <- sf::st_transform(us_limits_wgs84, crs = 5070)
us_limits_coord <- sf::st_coordinates(us_limits_albers)

dta %>%
  ggplot(aes(fill = grouping, geometry = geometry)) + 
  geom_sf(color = "red", size = 0.0) + 
  geom_sf(data = states, fill = "transparent", color = "white", size = .1) +
  scale_fill_manual(values = fill_scale) +
  theme_cori() +
  coord_sf(
    xlim = us_limits_coord[,'X'],
    ylim = us_limits_coord[,'Y'],
    datum = 5070,
    expand = FALSE
  ) +
  ggplot2::theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    rect = element_blank(),
    panel.grid.major = element_blank(),
    axis.line.x.bottom = element_blank()
  ) +
  ggplot2::labs(
    title = "Distribution of computer and math jobs",
    subtitle = "Share of computer and math employment by county, 2019",
    y = NULL,
    x = NULL,
    caption = "Source: 2019 ACS 5-year estimates"
  )

```


---
title: "Data visualization cookbook for the Center for Rural Innovation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data visualization cookbook for the Center for Rural Innovation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

## Installing Montserrat

```{r, message=FALSE, warning = FALSE}
library(sysfonts)
library(showtext)

# Loads Montserrat from the google font repository and adds it to sysfonts
sysfonts::font_add_google("Montserrat")
# Ensures that any newly opened graphics devices will use showtext to draw text
showtext_auto()
```

## How to create graphs using CORI themes

First load the necessary libraries
```{r, message = FALSE, warning = FALSE}
library(cori.charts)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
```

## Load your data

We will be using a dataset which gives the population with an income below the 
poverty level in the last 12 months for a subset of RIN communities.
```{r}
data(cori_poverty)
dplyr::glimpse(cori_poverty)
```
Now we are ready to begin charting!

----  

### Horizontal Bar Chart

```{r, dpi=300}

cori_poverty %>%
  ggplot2::ggplot(
    aes(
      estimate_below_poverty_level_2019,
      # Make RIN communities appear in descending order
      # based upon their population below the poverty level
      reorder(rin_community, estimate_below_poverty_level_2019)
    )
  ) +
  # Set the bar color the the CORI "Emerald" color
  ggplot2::geom_col(fill = cori_colors["Emerald"]) +
  # Add data labels to the bars
  geom_text(
    aes(
      # You can adjust the scales function depending on the desired
      # number format (e.g., percent, dollar, etc.)
      label = scales::number(
        estimate_below_poverty_level_2019,
        # accuracy determines what number to round to (e.g., accuracy = 0.01 will show 2 decimal places)
        accuracy = 1,
        # big.mark determines the character used between every 3 digits to separate thousands
        big.mark = ","
      )
    ),
    # Provide spacing between the data label and the bar position
    hjust = -.1,
    # Data labels need to have their font family explicitly set to "Montserrat"
    family = "Montserrat"
  ) +
  ggplot2::scale_x_continuous(
    # labels determines whether tick labels are shown
    labels = NULL,
    # You can provide an expansion multiplier to the axis to ensure that
    # data labels will have enough space
    expand = expansion(mult = c(.005, .1))
  ) +
  # Call the horizontal bar theme to pull in default CORI theming
  theme_cori_horizontal_bars() +
  # Override any defaults styles using the ggplot2::theme() function AFTER
  # calling theme_cori_horizontal_bars()
  ggplot2::theme(
    panel.grid.major.x = element_blank()
  ) +
  # Provide Title, subtitle, etc.
  ggplot2::labs(
    title = "Population living below the poverty level",
    subtitle = "For select RIN communities (2019)",
    y = NULL,
    x = NULL,
    caption = "Source: ACS 5-year estimates (2019)"
  )

```

----  

### Grouped Bar Chart

Pivot the data into a long format for easy plotting
```{r}

grouped_bar_data <- cori_poverty %>%
  mutate(
    percent_below_poverty_2014 = estimate_below_poverty_level_2014 / estimate_pop_2014,
    percent_below_poverty_2019 = estimate_below_poverty_level_2019 / estimate_pop_2019
  ) %>%
  pivot_longer(
    contains("percent"),
    names_to = "year",
    values_to = "percent_below_poverty"
  ) %>%
  mutate(
    year = str_remove(year, "percent_below_poverty_"),
    rin_community = reorder(rin_community, percent_below_poverty)
  ) 

```

With data labels
```{r, fig.asp = 0.8, fig.width = 5, dpi=300}

grouped_bar_data %>%
  ggplot(aes(percent_below_poverty, rin_community, fill = year)) +
  geom_col(position = "dodge") +
  # Add in data labels
  geom_text(
    # accuracy determines how many digits are shown
    # To show one decimal, update accuracy to 0.1
    aes(label = scales::percent(percent_below_poverty, accuracy = 1)),
    position = position_dodge2(width = 0.9, reverse = FALSE),
    hjust = -.1,
    family = "Montserrat"
  ) +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    # Axis labels are redundant to the data labels
    labels = NULL,
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: U.S. Census Bureau"
  ) +
  theme_cori_horizontal_bars()

```

Without data labels
```{r, fig.asp = 0.8, fig.width = 5, dpi=300}

grouped_bar_data %>%
  ggplot(aes(percent_below_poverty, rin_community, fill = year)) +
  geom_col(position = "dodge") +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    # Add back axis labels to provide context
    labels = scales::label_percent(accuracy = 1),
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: U.S. Census Bureau"
  ) +
  theme_cori_horizontal_bars()

```

----  

### Bullet Chart

```{r, fig.asp = 0.8, fig.width = 5, dpi=300, warning = FALSE, message = FALSE}

bullet_chart_data <- grouped_bar_data %>%
  dplyr::mutate(
    width = ifelse(year == "2014", 0.75, 0.5)
  )

bullet_chart_data %>%
  ggplot(aes(x = percent_below_poverty, y = rin_community, fill = year)) +
  geom_col(width = bullet_chart_data$width) +
  geom_text(
    data = dplyr::filter(bullet_chart_data, year == "2019"),
    aes(x = percent_below_poverty, label = scales::percent(percent_below_poverty, accuracy = 1)),
    hjust = 1.3,
    family = "Montserrat",
    color = "white"
  ) +
  scale_fill_cori(reverse = TRUE) +
  scale_x_continuous(
    labels = scales::label_percent(accuracy = 1),
    expand = expansion(mult = c(.005, .1))
  ) +
  labs(
    title = "Share of population below poverty level",
    subtitle = "For select CORI communities",
    x = NULL,
    y = NULL,
    caption = "Source: ACS 5-year estimates"
  ) +
  theme_cori_horizontal_bars()
```
